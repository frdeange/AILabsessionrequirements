{% extends 'base.html' %}
{% block title %}Results · Azure AI Provisioner{% endblock %}
{% block content %}

<!-- Required Info for Exercises Section -->
<h2 style="margin-top:0;">Required Info for Exercises</h2>
<div class="results-table-wrapper">
  <table class="results-table">
    <thead><tr><th>Key</th><th>Value</th><th>Copy</th></tr></thead>
    <tbody>
      <!-- OpenAI Endpoint -->
      {% if data.outputs.openai_endpoint %}
      <tr>
        <td class="key">OpenAI Endpoint</td>
        <td class="value">{{ data.outputs.openai_endpoint }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.openai_endpoint }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Azure OpenAI Key -->
      {% if data.outputs.azure_openai_key %}
      <tr>
        <td class="key">Azure OpenAI Key</td>
        <td class="value secret">{{ data.outputs.azure_openai_key }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.azure_openai_key }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- OpenAI Deployment Name -->
      {% if data.outputs.openai_deployment_name %}
      <tr>
        <td class="key">OpenAI Deployment Name</td>
        <td class="value">{{ data.outputs.openai_deployment_name }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.openai_deployment_name }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Azure Foundry Project URL -->
      {% if data.outputs.azure_foundry_project_url %}
      <tr>
        <td class="key">Azure Foundry Project URL</td>
        <td class="value">{{ data.outputs.azure_foundry_project_url }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.azure_foundry_project_url }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Azure AI Search URL -->
      {% if data.outputs.search_service_endpoint %}
      <tr>
        <td class="key">Azure AI Search URL</td>
        <td class="value">{{ data.outputs.search_service_endpoint }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.search_service_endpoint }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Azure AI Search Key -->
      {% if data.outputs.azure_search_admin_key %}
      <tr>
        <td class="key">Azure AI Search Key</td>
        <td class="value secret">{{ data.outputs.azure_search_admin_key }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.azure_search_admin_key }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- App Insights Connection String -->
      {% if data.outputs.app_insights_connection_string %}
      <tr>
        <td class="key">App Insights Connection String</td>
        <td class="value secret">{{ data.outputs.app_insights_connection_string }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.app_insights_connection_string }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Service Principal App ID -->
      {% if data.outputs.service_principal_app_id %}
      <tr>
        <td class="key">Service Principal App ID</td>
        <td class="value">{{ data.outputs.service_principal_app_id }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.service_principal_app_id }}">Copy</button></td>
      </tr>
      {% endif %}
      
      <!-- Service Principal Secret -->
      {% if data.outputs.service_principal_secret %}
      <tr>
        <td class="key">Service Principal Secret</td>
        <td class="value secret">{{ data.outputs.service_principal_secret }}</td>
        <td><button class="copy-btn" data-value="{{ data.outputs.service_principal_secret }}">Copy</button></td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- Download .env file -->
<div style="margin: 1.5rem 0; text-align: center;">
  <button id="downloadEnv" class="download-env-btn" onclick="downloadEnvFile('{{ deployment_id }}')">
    📄 Download .env file
  </button>
  <p style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.5rem;">
    Get all environment variables in a ready-to-use .env format
  </p>
</div>

<!-- Additional Details Section -->
<h2 style="margin-top:2rem;">Additional Details</h2>
<div class="results-table-wrapper">
  <table class="results-table">
    <thead><tr><th>Key</th><th>Value</th><th>Copy</th></tr></thead>
    <tbody>
      {% for k, v in data.outputs.items() %}
        {% if k not in ['openai_endpoint', 'azure_openai_key', 'openai_deployment_name', 'azure_foundry_project_url', 'search_service_endpoint', 'azure_search_admin_key', 'app_insights_connection_string', 'service_principal_app_id', 'service_principal_secret'] %}
        <tr>
          <td class="key">{{ k }}</td>
          <td class="value {% if 'key' in k or 'connection_string' in k %}secret{% endif %}">{{ v }}</td>
          <td><button class="copy-btn" data-value="{{ v }}">Copy</button></td>
        </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>

<p style="margin-top:1.4rem; font-size:.75rem; color:var(--text-dim);">Remember to rotate keys before sharing externally. Destroy resources when no longer needed.</p>
<p><a href="/">New deployment</a></p>

<style>
.download-env-btn {
  background: var(--gradient);
  color: white;
  border: none;
  padding: 0.8rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.download-env-btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.download-env-btn:active {
  transform: translateY(0px);
}
</style>
{% endblock %}
{% block body_end %}
<script>
  document.querySelectorAll('button.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      navigator.clipboard.writeText(btn.getAttribute('data-value'));
      btn.textContent = 'Copied';
      setTimeout(()=> btn.textContent='Copy', 1200);
    });
  });

  function downloadEnvFile(deploymentId) {
    const btn = document.getElementById('downloadEnv');
    btn.textContent = '⏳ Generating...';
    btn.disabled = true;
    
    fetch(`/download-env/${deploymentId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to generate .env file');
        }
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `azure-ai-${deploymentId.substring(0, 8)}.env`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        
        btn.textContent = '✅ Downloaded!';
        setTimeout(() => {
          btn.textContent = '📄 Download .env file';
          btn.disabled = false;
        }, 2000);
      })
      .catch(error => {
        console.error('Error:', error);
        btn.textContent = '❌ Error';
        setTimeout(() => {
          btn.textContent = '📄 Download .env file';
          btn.disabled = false;
        }, 2000);
      });
  }
</script>
{% endblock %}
